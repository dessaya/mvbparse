#include "gen.h"

#define BT 666.66666666666666666e-9 // ns

typedef struct {
    uint8_t master[3];
    uint8_t *slave;
    uint8_t slave_len;
} telegram_t;

static const telegram_t mvb_data[] = {
    { { 0x43, 0x90, 0xd6 }, (uint8_t[]){ 0x97, 0x1e, 0x00, 0x00, 0x00, 0x82, 0x14, 0x06, 0xdf, 0x1e, 0x0b, 0x31, 0x0f, 0x00, 0x17, 0x05, 0x8c, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x4d, 0xc9, 0x11, 0x94, 0x11, 0xa8, 0x11, 0xa8, 0x04, 0x05, 0x88 }, 36 },
    { { 0x43, 0x1b, 0xf7 }, (uint8_t[]){ 0x30, 0x00, 0x0f, 0x0c, 0x01, 0x10, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0xa8, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 36 },
    { { 0x00, 0x01, 0x34 }, (uint8_t[]){ 0x97, 0x1e, 0x07 }, 3 },
    { { 0x40, 0x10, 0xc5 }, (uint8_t[]){ 0x04, 0x00, 0x48, 0x30, 0x58, 0x00, 0x48, 0x80, 0x8f, 0x3b, 0xf0, 0x00, 0x00, 0x1b, 0xf9, 0x1b, 0xf9, 0x45, 0x2b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x69, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 36 },
    { { 0x01, 0xe9, 0xfc }, (uint8_t[]){ 0x00, 0x00, 0xff }, 3 },
    { { 0x40, 0x20, 0xfc }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 36 },
    { { 0x02, 0xe9, 0xe8 }, (uint8_t[]){ 0x00, 0x00, 0xff }, 3 },
    { { 0x40, 0x30, 0x52 }, (uint8_t[]){ 0x04, 0x00, 0x60, 0x30, 0x58, 0x00, 0x68, 0x80, 0x56, 0x3b, 0xfa, 0x00, 0x00, 0x1b, 0xfa, 0x3b, 0xfa, 0x22, 0x2c, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0xd7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 36 },
    { { 0x03, 0xe9, 0xe5 }, (uint8_t[]){ 0x00, 0x01, 0x34 }, 3 },
    { { 0xf0, 0xee, 0x24 }, (uint8_t[]){ 0x57, 0x08, 0x3c }, 3 },
    { { 0x30, 0x42, 0xcc }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 18 },
    { { 0x30, 0x52, 0x62 }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 18 },
    { { 0x30, 0x62, 0x5b }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 18 },
    { { 0x30, 0x72, 0xf5 }, (uint8_t[]){ 0xa0, 0x00, 0xa0, 0x00, 0xa0, 0x00, 0xa0, 0x00, 0x60, 0xa0, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, 18 },
    { { 0x30, 0x82, 0x2d }, (uint8_t[]){ 0xa0, 0x00, 0xa0, 0x00, 0xa0, 0x00, 0xa0, 0x00, 0x60, 0xa0, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, 18 },
    { { 0x30, 0x92, 0x83 }, (uint8_t[]){ 0xa0, 0x00, 0xa0, 0x00, 0xa0, 0x00, 0xa0, 0x00, 0x60, 0xa0, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, 18 },
    { { 0x30, 0x13, 0x4f }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 18 },
    { { 0x30, 0x23, 0x76 }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 18 },
    { { 0x30, 0x33, 0xd8 }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 18 },
    { { 0x30, 0x43, 0x07 }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 18 },
    { { 0x30, 0x53, 0xa9 }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 18 },
    { { 0x30, 0x63, 0x90 }, (uint8_t[]){ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 18 },
    { { 0x02, 0xe4, 0x2c }, (uint8_t[]){ 0x03, 0x00, 0xeb }, 3 },
    { { 0x03, 0xe4, 0x21 }, (uint8_t[]){ 0x03, 0x00, 0xeb }, 3 },
    { { 0x01, 0x2e, 0x34 }, (uint8_t[]){ 0xc0, 0x43, 0xfb }, 3 },
    { { 0x01, 0xe1, 0x4f }, (uint8_t[]){ 0x3b, 0xfa, 0x34 }, 3 },
    { { 0x01, 0xe5, 0xf3 }, (uint8_t[]){ 0xd6, 0x91, 0x03 }, 3 },
    { { 0x01, 0xb1, 0x07 }, (uint8_t[]){ 0x04, 0x00, 0xce }, 3 },
    { { 0x01, 0xb2, 0x92 }, (uint8_t[]){ 0x60, 0x30, 0x18 }, 3 },
    { { 0x01, 0xb5, 0xbb }, (uint8_t[]){ 0xd6, 0x77, 0x97 }, 3 },
    { { 0x01, 0xc1, 0xd8 }, (uint8_t[]){ 0x58, 0x00, 0xcb }, 3 },
    { { 0x01, 0xc2, 0x4d }, (uint8_t[]){ 0x68, 0x80, 0x47 }, 3 },
    { { 0x01, 0xc5, 0x64 }, (uint8_t[]){ 0xd6, 0x77, 0x97 }, 3 },
    { { 0x02, 0xe1, 0x5b }, (uint8_t[]){ 0x1b, 0xfa, 0x7e }, 3 },
    { { 0x02, 0xe5, 0xe7 }, (uint8_t[]){ 0xd6, 0x75, 0xc9 }, 3 },
    { { 0x03, 0xe1, 0x56 }, (uint8_t[]){ 0x3b, 0xfa, 0x34 }, 3 },
    { { 0x03, 0xe5, 0xea }, (uint8_t[]){ 0xd6, 0x71, 0x75 }, 3 },
    { { 0x01, 0x20, 0x65 }, (uint8_t[]){ 0x0e, 0x4a, 0xbd }, 3 },
    { { 0x01, 0x21, 0xae }, (uint8_t[]){ 0x38, 0x8d, 0xd6 }, 3 },
    { { 0x01, 0x2f, 0xff }, (uint8_t[]){ 0xd5, 0x9f, 0x46 }, 3 },
    { { 0x41, 0x10, 0xc8 }, (uint8_t[]){ 0x97, 0x1f, 0x74, 0x00, 0x00, 0x1e, 0x00, 0x00, 0xa0, 0x1c, 0xa7, 0x1c, 0xa7, 0x00, 0x00, 0x00, 0x00, 0x5f, 0x00, 0x00, 0x00, 0x00, 0x11, 0x94, 0x11, 0xa8, 0xc6, 0x11, 0xa8, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0xcf }, 36 },
    { { 0x41, 0x19, 0xb0 }, (uint8_t[]){ 0x00, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x03, 0x7a, 0x03, 0x79, 0x01, 0x04, 0x01, 0x67, 0x82, 0x00, 0x00, 0x03, 0x6f, 0x00, 0x00, 0x00, 0x00, 0xa6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 36 },
    { { 0x42, 0x19, 0xa4 }, (uint8_t[]){ 0x00, 0x05, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe6, 0x03, 0x7d, 0x03, 0x77, 0x01, 0x1d, 0x01, 0x3d, 0x4f, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x99, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 36 },
    { { 0x43, 0x19, 0xa9 }, (uint8_t[]){ 0x00, 0x05, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe6, 0x03, 0x79, 0x03, 0x7a, 0x01, 0x1d, 0x01, 0x35, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 36 },
    { { 0x42, 0x99, 0xa3 }, (uint8_t[]){ 0x7f, 0x36, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x1c, 0xa7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6c }, 36 },
    { { 0x43, 0x99, 0xae }, (uint8_t[]){ 0x7f, 0xb8, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x1c, 0xa7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6c }, 36 },
    { { 0x42, 0x90, 0xdb }, (uint8_t[]){ 0x97, 0x1f, 0x00, 0x00, 0x00, 0x82, 0x14, 0x06, 0x2b, 0x1e, 0x0b, 0x31, 0x0f, 0x00, 0x17, 0x05, 0x8c, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x93, 0xd7, 0x11, 0x94, 0x11, 0xa8, 0x11, 0xa8, 0x04, 0x05, 0x88 }, 36 },
    { { 0x43, 0x90, 0xd6 }, (uint8_t[]){ 0x97, 0x1f, 0x00, 0x00, 0x00, 0x82, 0x14, 0x06, 0x2b, 0x1e, 0x0b, 0x31, 0x0f, 0x00, 0x17, 0x05, 0x8c, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x4d, 0xc9, 0x11, 0x94, 0x11, 0xa8, 0x11, 0xa8, 0x04, 0x05, 0x88 }, 36 },
    { { 0x42, 0x9a, 0x36 }, (uint8_t[]){ 0x7f, 0x37, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xf8, 0x00, 0xa6, 0x00, 0xc6, 0x01, 0x39, 0x00, 0x00, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 36 },
    { { 0x43, 0x9a, 0x3b }, (uint8_t[]){ 0x7f, 0xb8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xf8, 0x00, 0xa6, 0x00, 0xc6, 0x01, 0x39, 0x00, 0x00, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff }, 36 },
};

static const int mvb_data_len = sizeof(mvb_data) / sizeof(mvb_data[0]);

static sendbuf_t sendbuf = { 0 };

void sendbuf_reset() {
    sendbuf.bytes = 1;
    sendbuf.bits = 0;
    sendbuf.data[sendbuf.bytes - 1] = 0xff;
}

static void sendbuf_add_bit(uint8_t v) {
    if (!v) {
    	sendbuf.data[sendbuf.bytes - 1] &= ~(1 << (7 - sendbuf.bits));
    }
    sendbuf.bits++;
    if (sendbuf.bits == 8) {
        sendbuf.bytes++;
        sendbuf.bits = 0;
        sendbuf.data[sendbuf.bytes - 1] = 0xff;
    }
}

static void send_n(int amount, uint8_t v) {
    for (int i = 0; i < amount; i++) {
        sendbuf_add_bit(v);
    }
}

typedef enum { BIT_0, BIT_1, BIT_NH, BIT_NL, } bit_t;

static void send_high() {
    sendbuf_add_bit(1);
}

static void send_low() {
    sendbuf_add_bit(0);
}

// 3.3.1.2 Bit encoding
static void send_bit(bit_t bit) {
    switch (bit) {
        case BIT_1:
            send_high();
            send_low();
            break;
        case BIT_0:
            send_low();
            send_high();
            break;
        case BIT_NH:
            send_high();
            send_high();
            break;
        case BIT_NL:
            send_low();
            send_low();
            break;
    }
}

// 3.3.1.4 Start Bit
static void send_start_bit() {
    send_bit(BIT_1);
}

// 3.3.1.5 Start Delimiter
static void send_master_start_delimiter() {
    send_bit(BIT_NH);
    send_bit(BIT_NL);
    send_bit(BIT_0);
    send_bit(BIT_NH);
    send_bit(BIT_NL);
    send_bit(BIT_0);
    send_bit(BIT_0);
    send_bit(BIT_0);
}

// 3.3.1.5 Start Delimiter
static void send_slave_start_delimiter() {
    send_bit(BIT_1);
    send_bit(BIT_1);
    send_bit(BIT_1);
    send_bit(BIT_NL);
    send_bit(BIT_NH);
    send_bit(BIT_1);
    send_bit(BIT_NL);
    send_bit(BIT_NH);
}

// 3.3.1.6 End Delimiter
static void send_end_delimiter() {
    send_bit(BIT_NL);
    send_bit(BIT_NH);
}

static void send_byte(uint8_t byte) {
    for (int i = 7; i >= 0; i--) {
        bit_t bit = (byte >> i) & 0x1;
        send_bit(bit);
    }
}

static void send_bytes(const uint8_t bytes[], int len) {
    for (int i = 0; i < len; i++) {
        send_byte(bytes[i]);
    }
}

// 3.4.1.1 Master Frame format
static void send_master(const uint8_t bytes[]) {
    send_start_bit();
    send_master_start_delimiter();
    send_bytes(bytes, 3);
    send_end_delimiter();
}

// 3.4.1.2 Slave Frame format
static void send_slave(const uint8_t bytes[], int len) {
    send_start_bit();
    send_slave_start_delimiter();
    send_bytes(bytes, len);
    send_end_delimiter();
}

sendbuf_t *next_telegram() {
    static size_t i = 0;

    sendbuf_reset();

    send_master(mvb_data[i].master);
    send_n(15, 1);
    send_slave(mvb_data[i].slave, mvb_data[i].slave_len);

    i++;
    if (i == mvb_data_len) {
        i = 0;
    }

    return &sendbuf;
}
